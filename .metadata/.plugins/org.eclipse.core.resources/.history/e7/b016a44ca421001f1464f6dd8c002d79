<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>공지사항 목록</title>
<style>
    .float-left {
        float: left;
        margin: 5px;
    }
</style>
<jsp:include page="../include/head.jsp"></jsp:include>
</head>
<body>
<div class="full-wrap">
    <header id="hd">
        <div class="container">
            <jsp:include page="../include/hd.jsp"></jsp:include>
        </div>
    </header>
    <main id="contents" class="contents">
        <section class="page" id="page1">
            <h2 class="page-title">테스트</h2>
            <div class="page-wrap">
                <div class="template">
                    <form>
                        <input type="text" class="message" onkeydown="if(event.keyCode === 13) return false;">
                        <input value="Send" type="button" class="sendBtn">
                    </form>
                    <br />
                    <textarea rows="10" cols="50" class="console" disabled="disabled"></textarea>
                </div>
                <script type="text/javascript">
                    var webSocket = new WebSocket("ws://" + location.host + "/myapp/admin");
                    webSocket.onopen = function() { };
                    webSocket.onclose = function() { };
                    webSocket.onerror = function() { };
                    webSocket.onmessage = function(message) {
                        console.log(message);
                        let node = JSON.parse(message.data);
                        console.log(node);
                        if (node.status === "visit") {
                            let form = $(".template").html();
                            form = $("<div class='float-left'></div>").attr("data-key", node.key).append(form);
                            $("body").append(form);
                        } else if (node.status === "message") {
                            let $div = $("[data-key='" + node.key + "']");
                            let $console = $div.find(".console");
                            $console.val($console.val() + "\n" + node.message);
                        } else if (node.status === "bye") {
                            $("[data-key='" + node.key + "']").remove();
                        }
                    };

                    $("body").on("click", ".sendBtn", function() {
                        let $div = $(this).closest("div[data-key]");
                        let key = $div.attr("data-key");
                        let $input = $div.find(".message");
                        let message = $input.val();
                        webSocket.send(key + "#####" + message);
                        $input.val("");
                    });
                </script>
            </div>
        </section>
    </main>
    <footer id="ft">
        <jsp:include page="../include/ft.jsp"></jsp:include>
    </footer>
</div>
</body>
</html>
